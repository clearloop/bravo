
### 第五章 钱包

比特币钱包分为非确定性钱包和确定性钱包，非确定性钱包中每个密钥都是从随机数独立生成的，确定性钱包所以密钥都是从主密钥派生而来的。  

> 钱包控制用户访问权限，管理密钥和地址，跟踪余额以及创建和签名交易。狭义上，即从程序员的角度来看，“钱包”是指用于存储和管理用户密钥的数据结构。比特币钱包只含密钥，是密钥链。

**非确定性钱包。**比特币核心客户端预先生成100个随机私钥，从最开始就生成足够多的私钥并且每个密钥只使用一次。

![randomWallt](/assets/randomWallet.png)

> 这种钱包现在正在被确定性钱包替换，因为它们难以管理、 备份以及导入。随机密钥的缺点就是如果你生成很多私钥，你必须保存它们所有的副本。这就意味着这个钱包必须被经常性 地备份。每一个密钥都必须备份，否则一旦钱包不可访问时，钱包所控制的资金就付之东流。

**确定性钱包。**确定性，或者“种子”钱包包含通过使用单项离散函数而可从公共的种子生成的私钥。种子是随机生成的数字。

![certainWallt](/assets/certainWallet.png)

> 在确定性钱包中，种子足够恢复所有的已经产生的私钥，所以只用在初始创建时的一个简单备份就足以搞定。并且种子也足够让钱包导入或者导出。这就很容易允许使用者的私钥在钱包之间轻松转移。

**分层确定性钱包。**确定性钱包被开发成更容易从单个“种子”中生成许多密钥。确定性钱包的最高级形式是通过BIP0032标准定义的HD钱包。HD钱包包含以树状结构衍生的密钥，使得父密钥可以衍生一系列子密钥，每个子密钥又可以衍生出一系列孙密钥，以此类推，无限衍生。

![hdWallet](/assets/hdWallet.png)

> 相比较随机（不确定性）密钥，HD钱包有两个主要的优势。  
> 第一，树状结构可以被用来表达额外的组织含义。  
> 第二，它可以允许让使用者去建立一个公共密钥的序列而不需要访问相对应的私钥。

**种子和助记词**。由一系列英文单词生成种子是个标准化方法，这样易于在钱包中转移，导出和导入，如果 HD 钱包与这种方法相结合，将会更加有用。

**钱包最佳实践**

| BIP-39 | BIP-32  | BIP-43             | BIP-44             |
|--------|---------|--------------------|--------------------|
| 助记码 | HD 钱包 | 多用途 HD 钱包结构 | 多币种和多账户钱包 |

> 如果您正准备开发一个比特币钱包，那么它应该被构建为一个 HD 钱包，一个种子被编码为助记词代码进行备份，遵循BIP-32，BIP-39，BIP-43和BIP-44标准，下面章节有所涉猎。

### 钱包技术细节

**助记码词汇**  
助记码词汇是英文单词序列代表 (编码) 用作种子对应所确定性钱包的随机数。单词的序列足以重新创建种子，并且从种子哪里重新创造钱包以及所有私钥。

> 助记词经常与“脑钱包”混淆。 他们不一样。主要区别在于脑钱包由用户选择的单词组成，而助记符是由钱包随机创建的，并呈现给用户。 这个重要的区别使助记词更加安全，因为人类猜测随机数还是无能为力。

**创建助记词汇**  
![mwords](/assets/mwords.png)
+ 创建一个 128 到 256 位的随机序列 (熵)。
+ 提出 SHA256 哈希前几位 (熵长/32)，就可以创造一个随机序列的校验和。
+ 将校验和添加到随机序列的末尾。
+ 将序列划分为包含 11 位的不同部分
+ 将每个包含 11 位部分的值与一个已经预先定义 2048 个单词的字典做对应。
+ 生成的有顺序的单词组就是助记码。

**从助记词生成种子**  
![mseed](/assets/mseed.png)
>助记词表示长度为 128至256位 的熵。通过使用密钥延伸函数PBKDF2，熵被用于导出较长的（512位）种子。将所得的种子用于构建确定性钱包并得到其密钥。

**BIP-39中的可选密码短语**  
HD 钱包从单个根种子中创建，简单的转移 HD 钱包的根种子就能够让 HD 钱包中所包含的成千上百万的密钥被复制，存储导出以及导入。
![seedtohd](/assets/seedtohd.png)

**私有密钥的衍生**  
母私钥，链码，索引相结合并散列可以生成子密钥。改变索引可以染你过年我们延长母密钥以及创造序列中的其他子密钥。  
子私钥不能从那非确定性密钥中被区分出来。因为衍生函数是单向的，所以子密钥不能被用来发现他们的母密钥。子密钥也不能用来发现他们的相同层级的姊妹密钥。
> 子私钥、对应的公钥以及比特币地址都不能从随机创造的密钥和地址中被区分出来。事实是它们所在的序列，在创造他们的HD钱包函数之外是不可见的。一旦被创造出来，它们就和“正常”密钥一样运行了。


**扩展密钥**  
正如我们之前看到的，密钥衍生函数可以被用来创造密钥树上任何层级的子密钥。这只需要三个输入量：一个密钥，一个链码以及想要的子密钥的索引。密钥以及链码这两个重要的部分被结合之后，就叫做扩展密钥（extended key）。
>一个扩展密钥包括一个私钥（或者公钥）以及一个链码。一个扩展密钥可以创造出子密钥并且能创造出密钥树结构中的整个分支。分享扩展密钥就可以访问整个分支。

**公共子密钥推导**  
我们可以通过子私钥产生子公钥，或者通过母公钥产生子公钥。从扩展公钥衍生一个分支公钥的能力是很重要的，但牵扯一些风险。访问扩展公钥并不能得到访问子私钥的途径。

**索引号码**  
用在衍生函数中的索引号码是32位的整数。为了区分密钥是从正常衍生函数中衍生出来还是从强化衍生函数中产出，这个索引号被分为两个范围。
> HD钱包中的密钥是用“路径”命名的，且每个级别之间用斜杠（/）字符来表示（见表5-6）。由主私钥衍生出的私钥起始以“m”打头。由主公钥衍生的公钥起始以“M“打头。因此，母密钥生成的第一个子私钥是m/0。第一个公钥是M/0。第一个子密钥的子密钥就是m/0/1，以此类推

**HD 钱包树状结构导航**
HD钱包树状结构提供了极大的灵活性。每一个母扩展密钥有40亿个子密钥：20亿个常规子密钥和20亿个强化子密钥。 而每个子密钥又会有40亿个子密钥并且以此类推。只要你愿意，这个树结构可以无限类推到无穷代。但是，又由于有了这个灵活性，对无限的树状结构进行导航就变得异常困难。尤其是对于在不同的HD钱包之间进行转移交易，因为内部组织到内部分支以及亚分支的可能性是无穷的。  

BIP-43  
HD钱包使用且只用第一层级的树的分支，而且有索引号码去识别结构并且有命名空间来定义剩余的树的目的地。

BIP-44  
所有遵循BIP-44的HD钱包依据只使用树的第一个分支的要求而被定义：m/44'/。BIP-44指定了包含5个预定义树状层级的结构：  
m / purpose' / coin_type' / account' / change / address_index

| HD路径           | 主要描述                                 |
|------------------|------------------------------------------|
| M/44'/0'/0/2     | 第三个收到公共钥匙的主比特币账户         |
| M/44'/0'/3'/1/14 | 第十五改变地址公钥的第四个比特币账户     |
| m/44'/2'/0'/0/1  | 为了签署交易的在莱特币主账户的第二个私钥 |


<style>img{ padding: 5rem 10vw }</style>
