## 第四章 密钥和地址

### 简介
数字密钥完全独立于比特币协议。但发送交易时，输入比特币网络的交易信息应该是符合比特币协议标准的。密钥实现了比特币的去中心化信任和控制，所有权认证和基于密码学证明的安全模型。
+ 密钥成对出现，比特币交易需要一个有效的签名才能够存入区块链，用于支出资金的数字签名被称为见证(witness)。
+ 收件人的公钥地址被称为比特币地址，比特币地址由一个公钥生成并对应于这个公钥。并非所有比特币地址都是公钥，他们也可以表示其他支付对象，譬如脚本。

> 比特币的所有权是通过数字密钥、比特币地址和数字签名来确定的。数字密钥实际上并不存储在网络中，而是由用户生成之后，存储在一个叫做钱包的文件或简单的数据库中。存储在用户钱包中的数字密钥完全独立于比特币协议，可由用户的钱包软件生成并管理，而无需参照区块链或访问网络。密钥实现了比特币的许多有趣特性，包括去中心化信任和控制、所 有权认证和基于密码学证明的安全模型。

密钥对包括一个私钥，和由其衍生出的唯一公钥。公钥用于接收比特币，而私钥用于比特币支付时的交易签名。私钥可用于生产特定消息的签名，此签名可以在不泄露私钥的同时对公钥进行验证。
> 大多数比特币钱包工具为了方便会将私钥和公钥以密钥对的形式存储在一起。然而，公钥可以由私钥计算得到， 所以只存储私钥也是可以的。

### 比特币私钥与公钥
生成比特币私钥在本质上与 "在1到2^256之间选一个数字" 无异，只要结果不可预测或不可重复，那么选取数字的具体方法并不重要。  
公钥由私钥通过椭圆曲线乘法获得，椭圆曲线加密法是一种基于离散对数问题的非对称加密法，可以用对椭圆曲线上的点进行加法或乘法运算来表示。

![ECC](/assets/ecc.png)
> 大多数比特币程序使用OpenSSL加密库进行椭圆曲线计算。例如，调用EC_POINT_mul() 函数，可计算得到公钥。

### 比特币地址
比特币地址以数字 "1" 开头。可由公钥经过单向的加密哈希算法得到加密哈希函数在比特币中被广泛使用： 比特币地址、脚本地址以及在挖矿中的工作量证明算法。  
通常用户见到的比特币地址是经过 "Base58Check" 编码的，Base58Check 编码也被用于比特币的其他地方。  

> 为了更简洁方便地表示长串的数字，使用更少的符号，许多计算机系统会使用一种以数字和字母组成的大于十进制的表示法。

Base58Chek 由前缀、数据和校验和组成。我们为 Base58 数据添加叫做 "版本字节" 的前缀，并计算 "双哈希" 校验和，制作 Base58Check。

![base58check](/assets/base58check.png)

>为了更简洁方便地表示长串的数字，使用更少的符号，许多计算机系统会使用一种以数字和字母组成的大于十进制的表示法。Base64通常用于编码邮件中的附件。Base58 是一种基于文本的二进制编码格式，用在比特币和其它的加密货币中。这种编码格式不仅实现了数据压缩，保持了易读 性，还具有错误诊断功能。为了增加防止打印和转录错误的安全性，Base58Check是一种常用在比特币中的Base58编码格式，比特币有内置的检查错误的编码。

### 密钥的格式
公钥和私钥的都可以有多种格式。一个密钥被不同的格式编码后，虽然结果看起来可能不同，但是密钥所编码数字并没有改变。  
**压缩格式公钥**，引入压缩格式公钥是为了减少比特币交易的字节数，从而可以节省那些运行区块链数据库的节点磁盘空间。  
**压缩格式私钥**，私钥是非压缩的，也不能被压缩。  

私钥的格式如此：

| Type           | Prefix | Description                                                                 |
|:--------------:|:------:|:---------------------------------------------------------------------------:|
| Raw            | None   | 32 bytes                                                                    |
| Hex            | None   | 64 hexadecimal digits                                                       |
| WIF            | 5      | Base58Check encoding: Base58 with version prefix of 128- and 32-bitchecksum |
| WIF-compressed | K or L | As above, with added suffix 0x01 before encoding                            |

例如：

| Format         | Private                                                          |
|:--------------:|:----------------------------------------------------------------:|
| Hex            | 1e99423a4ed27608a15a2616a2b0e9e52ced330ac530edcc32c8ffc6a526aedd |
| WIF            | 5J3mBbAH58CpQ3Y5RNJpUKPE62SQ5tfcvU2JpbnkeyhfsYB1Jcn              |
| WIF-compressed | KxFC1jmwwCoACiCAWZ3eXa96mBM6tb3TYzGmf6YwgdGWZgawvrtJ             |

公钥格式：

| Key | Value                                                                                                                               |
|:---:|:------------------------------------------------------------------------------------------------------------------------------------|
| x   | F028892BAD7ED57D2FB57BF33081D5CFCF6F9ED3D3D7F159C2E2FFF579DC341A                                                                    |
| y   | 07CF33DA18BD734C600B96A72BBC4749D5141C90EC8AC328AE52DDFE2E505BDB                                                                    |
| K   | 04F028892BAD7ED57D2FB57BF33081D5CFCF6F9ED3D3D7F159C2E2FFF579DC341A07CF33DA18BD734C600B96A72BBC4749D5141C90EC8AC328AE 52DDFE2E505BDB |

> 实际上“压缩格式私钥”是一种名称上的误导，因为当一个私钥被使用WIF压缩格式导出时，不但没有压缩，而且比“非压缩格式”私钥长出一个字节。这个多出来的一个字节是私钥被加了后缀01，用以表明该私钥是来自于一个较新的钱包， 只能被用来生成压缩的公钥。

### 高级密钥和地址
BIP0038 加密后的密钥前缀为 "6P"，解开它需要一个长密码(由多个单词或一段复杂的数字字母字符串组成)作为口令，原比特币私钥通常使用 WIF 编码过。

> Base58Check编码的比特币地址是以1开头的，而Base58Check编码的私钥WIF是以5开头的。

| Private Key (WIF)                                    | Passphrase        |
|:----------------------------------------------------:|:-----------------:|
| 5J3mBbAH58CpQ3Y5RNJpUKPE62SQ5tfcvU2JpbnkeyhfsYB1JcnA | A String You Want |

以数字3开头的比特币地址是P2SH地址，有时被错误的称谓多重签名或多重签名地址。他们指定比特币交易中受益人为哈希的脚本，而不是公钥的所有者。他们指定比特币交易中受益人为哈希的脚本，而不是公钥的所有者。  
P2SH函数最常见的实现是多重签名地址脚本，设计比特币多重签名特性是需要从总共N个密钥中需要M个签名（也被称为“阈值”），被称为M-N多签名，其 中M是等于或小于N。

| Type | Prefix |
|:----:|:------:|
| Raw  | 1      |
| P2SH | 3      |
| WIF  | 5      |

## 疑问 🤔️

##### 钱包生成多个地址，发送一笔交易后返回的新的 UTXO 是否会以新的地址为形式再次存储到钱包里，密钥到底是针对钱包还是某个地址？

##### BTC 的私钥是否可重复，如果重复，会发生什么事情？

<style>img{ padding: 5rem 10vw }</style>
